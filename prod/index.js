function doorAction(a,b){if(!(doors[a].cd<=0))return"cooldown is greater then zero";switch(b){case"o":doors[a].st="c",doors[a].cd=COOLDOWN_SECONDS;break;case"c":doors[a].st="o",doors[a].cd=COOLDOWN_SECONDS;break;default:return"illegal request"}}function voteAction(a){return vote[a].cd<=0?(vote[a].st="o",void(vote[a].cd=VOTE_COOLDOWN_SECONDS)):"cooldown is greater then zero"}var express=require("express"),app=express(),http=require("http").Server(app),io=require("socket.io")(http),fs=require("fs"),buttonStatisticFile="button_statistic.json",buttonClicked={feed:0,scare:0},HTTP_PORT=3e3,UDP_PORT=1337,COOLDOWN_SECONDS=3,VOTE_COOLDOWN_SECONDS=20,doors={d1:{st:"o",cd:0},d2:{st:"o",cd:0},d3:{st:"o",cd:0},d4:{st:"o",cd:0},d5:{st:"o",cd:0},d7:{st:"o",cd:0},d9:{st:"o",cd:0},d10:{st:"o",cd:0},d11:{st:"o",cd:0},d12:{st:"o",cd:0},d13:{st:"o",cd:0},d14:{st:"o",cd:0},d15:{st:"o",cd:0},d16:{st:"o",cd:0},d17:{st:"o",cd:0}},doorsForClients={d1:{text:"1"},d2:{text:"2"},d3:{text:"3"},d4:{text:"4"},d5:{text:"5"},d7:{text:"7"},d9:{text:"9"},d10:{text:"10"},d11:{text:"11"},d12:{text:"12"},d13:{text:"13"},d14:{text:"14"},d15:{text:"15"},d16:{text:"16"},d17:{text:"17"}},vote={feed:{st:"o",cd:0},scare:{st:"o",cd:0}};setInterval(function(){var a;for(a in doors)0===--doors[a].cd&&io.emit("door",JSON.stringify({id:a,data:doors[a]}));for(a in vote)0===--vote[a].cd&&(vote[a].st="c",io.emit("vote",JSON.stringify({id:a,data:vote[a]})))},1e3),app.use("/",express["static"]("public")),io.on("connection",function(a){var b=a.id;a.on("labirint_setup",function(a){io.sockets.connected[b].emit("labirint_setup",JSON.stringify(doorsForClients))}),a.on("allDoors",function(a){io.sockets.connected[b].emit("allDoors",JSON.stringify(doors))}),a.on("disconnect",function(){}),a.on("door",function(a){var b=JSON.parse(a),c=b.id,d=b.s;doorAction(c,d);io.emit("door",JSON.stringify({id:c,data:doors[c]}))}),a.on("vote",function(a){var c=JSON.parse(a),d=c.action;if(void 0!==vote[d]){buttonClicked[d]+=1;var e=voteAction(d);void 0!==e||(io.sockets.connected[b].emit("vote",JSON.stringify({id:d,data:vote[d]})),io.emit("vote",JSON.stringify({id:d,data:vote[d]})))}}),a.on("message_to_server",function(a){io.sockets.emit("message_to_client",{message:a.message})})}),http.listen(HTTP_PORT,function(){});var iskraServer=require("net").createServer(function(a){a.on("data",function(b){"Get"==b&&(a.write(JSON.stringify({feed:vote.feed.st,scare:vote.scare.st,doors:doors})),vote.feed.st="c",vote.scare.st="c"),"Scare"==b&&(a.write(JSON.stringify({scare:vote.scare.st})),vote.scare.st="c")}),a.pipe(a)});iskraServer.listen(UDP_PORT,"0.0.0.0"),fs.readFile(buttonStatisticFile,"utf8",function(a,b){a&&fs.writeFile("button_statistic.json",JSON.stringify(buttonClicked),function(a){}),buttonClicked=JSON.parse(b),setInterval(function(){fs.writeFile(buttonStatisticFile,JSON.stringify(buttonClicked),function(a){})},6e4)});