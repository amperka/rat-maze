function doorAction(a,b){if(!(doors[a].cd<=0))return"cooldown is greater then zero";switch(b){case"o":doors[a].st="c",doors[a].cd=COOLDOWN_SECONDS;break;case"c":doors[a].st="o",doors[a].cd=COOLDOWN_SECONDS;break;default:return"illegal request"}}function voteAction(a){return vote[a].cd<=0?(vote[a].st="o",void(vote[a].cd=VOTE_COOLDOWN_SECONDS)):"cooldown is greater then zero"}var express=require("express"),app=express(),http=require("http").Server(app),io=require("socket.io")(http),fs=require("fs"),buttonStatisticFile="button_statistic.json",buttonClicked={feed:0,scare:0},HTTP_PORT=3e3,UDP_PORT=1337,COOLDOWN_SECONDS=3,VOTE_COOLDOWN_SECONDS=20,doors={d1:{st:"o",cd:0},d2:{st:"o",cd:0},d3:{st:"o",cd:0},d4:{st:"o",cd:0},d5:{st:"o",cd:0},d7:{st:"o",cd:0},d8:{st:"o",cd:0},d9:{st:"o",cd:0},d10:{st:"o",cd:0},d11:{st:"o",cd:0},d12:{st:"o",cd:0},d13:{st:"o",cd:0},d14:{st:"o",cd:0},d15:{st:"o",cd:0},d16:{st:"o",cd:0},d17:{st:"o",cd:0}},vote={feed:{st:"o",cd:0},scare:{st:"o",cd:0}};setInterval(function(){var a;for(a in doors)0===--doors[a].cd&&io.emit("door",JSON.stringify({id:a,data:doors[a]}));for(a in vote)0===--vote[a].cd&&(console.log("vote["+a+"] ready!"),vote[a].st="c",io.emit("vote",JSON.stringify({id:a,data:vote[a]})))},1e3),app.use("/",express["static"]("public")),io.on("connection",function(a){console.log("new connection: "+a.id);var b=a.id;a.on("labirint_setup",function(a){console.log("labirint_setup: "+a),io.sockets.connected[b].emit("labirint_setup",JSON.stringify(doors))}),a.on("allDoors",function(a){io.sockets.connected[b].emit("allDoors",JSON.stringify(doors))}),a.on("disconnect",function(){console.log("user "+b+" disconnected")}),a.on("door",function(a){console.log("door: "+a);var b=JSON.parse(a),c=b.id,d=b.s,e=doorAction(c,d);void 0!==e&&console.log(e),io.emit("door",JSON.stringify({id:c,data:doors[c]}))}),a.on("vote",function(a){console.log("vote: "+a);var c=JSON.parse(a),d=c.action;if(void 0!==vote[d]){buttonClicked[d]+=1;var e=voteAction(d);void 0!==e?console.log(e):(io.sockets.connected[b].emit("vote",JSON.stringify({id:d,data:vote[d]})),io.emit("vote",JSON.stringify({id:d,data:vote[d]})))}}),a.on("message_to_server",function(a){io.sockets.emit("message_to_client",{message:a.message})})}),http.listen(HTTP_PORT,function(){console.log("listening on: "+HTTP_PORT)});var iskraServer=require("net").createServer(function(a){a.on("data",function(b){console.log("Server received: "+b),a.write(JSON.stringify({feed:vote.feed.st,scare:vote.scare.st,doors:doors})),vote.feed.st="c",vote.scare.st="c",console.log("votes commands sent to Iskra.JS and reset")}),a.pipe(a)});iskraServer.listen(UDP_PORT,"0.0.0.0"),fs.readFile(buttonStatisticFile,"utf8",function(a,b){a&&(console.log(a),fs.writeFile("button_statistic.json",JSON.stringify(buttonClicked),function(a){return console.log(a)})),console.log("read clicked buttons statistic: ",b),buttonClicked=JSON.parse(b),setInterval(function(){fs.writeFile(buttonStatisticFile,JSON.stringify(buttonClicked),function(a){return a?console.log(a):void console.log("save clicked buttons statistic: ",buttonClicked)})},1e4)});